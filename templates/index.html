<!DOCTYPE html>
<html>
<head>
    <title>Patient Registry</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="p-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-3">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="container">
        <h1 class="mb-4">Patient Registry</h1>

        <div id="countdown" class="position-fixed top-0 end-0 m-3 text-muted small">
            Auto-logout in: <span id="countdown-timer">120</span> sec
        </div>        

        <!-- Search Form -->
        <form method="GET" action="/search" class="row g-3 mb-3">
            <div class="col-md-10">
                <input type="text" class="form-control" name="q" placeholder="Search by name or condition">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">Search</button>
            </div>
        </form>

        <!-- Add Patient Form -->
        <form action="/add" method="post" class="row g-3 mb-5">
            <div class="col-md-4">
                <input class="form-control" type="text" name="name" placeholder="Name" required>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" name="age" placeholder="Age">
            </div>
            <div class="col-md-4">
                <input class="form-control" type="text" name="condition" placeholder="Condition">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">Add</button>
            </div>
        </form>

        <!-- Patients Table -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th class="text-primary text-decoration-underline" style="cursor: pointer;">Name</th>
                    <th class="text-primary text-decoration-underline" style="cursor: pointer;">Age</th>
                    <th class="text-primary text-decoration-underline" style="cursor: pointer;">Condition</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for p in patients %}
                    <tr>
                        <td>{{ p[1] }}</td>
                        <td>{{ p[2] }}</td>
                        <td>{{ p[3] }}</td>
                        <td>
                            <a href="/delete/{{ p[0] }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this patient?');">Delete</a>
                            <a href="/edit/{{ p[0] }}" class="btn btn-primary btn-sm">Edit</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
          {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
              <a class="page-link" href="/?page={{ p }}">{{ p }}</a>
            </li>
          {% endfor %}
        </ul>
    </nav>
    
    {% if session.get('role') == 'admin' %}
        <div class="my-4 d-flex gap-3 justify-content-center">
            <a href="{{ url_for('register') }}" class="btn btn-outline-primary">‚ûï Register New Doctor</a>
            <a href="{{ url_for('list_doctors') }}" class="btn btn-outline-secondary">üë®‚Äç‚öïÔ∏è Manage Doctors</a>
        </div>
    {% endif %}

    {% if session.get('logged_in') %}
        <div class="d-flex justify-content-center mt-4">
            <a href="/logout" class="btn btn-primary">Logout</a>
        </div>
    {% endif %}

    <!-- Auto-remove flash messages -->
    <script>
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.remove());
        }, 5000);
    </script>

    <!-- Client-side table sorting -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.querySelector('table');
            const headers = table.querySelectorAll('th');
            const tbody = table.querySelector('tbody');

            headers.forEach((header, index) => {
                if (header.textContent === 'Action') return;

                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isNumeric = index === 1;

                    const sortedRows = rows.sort((a, b) => {
                        const valA = a.children[index].textContent.trim();
                        const valB = b.children[index].textContent.trim();

                        if (isNumeric) {
                            return Number(valA) - Number(valB);
                        }
                        return valA.localeCompare(valB);
                    });

                    if (header.classList.contains('asc')) {
                        sortedRows.reverse();
                        header.classList.remove('asc');
                    } else {
                        header.classList.add('asc');
                        headers.forEach(h => {
                            if (h !== header) h.classList.remove('asc');
                        });
                    }

                    tbody.innerHTML = '';
                    sortedRows.forEach(row => tbody.appendChild(row));
                });
            });
        });
    </script>

    <!-- Real-time session countdown synced with server -->
    <script>
        let countdownInterval;

        function fetchRemainingTime() {
            fetch('/session-status')
                .then(response => response.json())
                .then(data => {
                    const timeLeft = data.remaining;
                    const display = document.getElementById('countdown-timer');
                    
                    if (display) {
                        display.textContent = timeLeft;
                    }

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = "/logout";
                    }
                })
                .catch(err => {
                    console.error('Error fetching session status:', err);
                });
        }

        countdownInterval = setInterval(fetchRemainingTime, 1000);
        fetchRemainingTime();
    </script> 
</body>
</html>
